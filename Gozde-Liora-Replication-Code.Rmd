---
title: "Gozde and Liora Replication Code"
author: "Gozde Guran and Liora Goldensher"
date: "3/6/2015"
output: html_document
---

# Replication Code for "Contextual Factors and the Extreme Right Vote in Europe, 1980-2002" by Kai Arzheimer American Journal of Political Science (2009)

# Run necessary packages and load data (Source: Arzheimer dataverse)

```{r}
library(Zelig)
library(lme4)
library(MASS)
library(nlme)
library(plm)
library(xtable)
library(foreign)
library(dplyr)
library(broom)
library(ggplot2)
library(xtable)
library(stargazer)
data <- read.dta("nonimp.dta")
```


# Create centered variables for Saliance and Variance based on grand mean centering according to author

```{r}
data <- data  %>% 
  mutate(salienzmean.c = (salienzmean - 3.84568))%>% 
  mutate(rvar.c = rvar - 21.75423)
```

# Make male variable numeric

```{r}
data <- data %>%
  mutate(male = as.numeric(male))
```

# Create a dummy variable for country (transform from character to factor variable)

```{r}
data <- data %>%
  mutate(country = factor(sortcountry, labels=c("AT", "BE","DE-E","DE-W","DK","ES","FI","FR","GR","IT","LU","NL","NO","PT","SE")))
```

# Plot Data 

```{r}
ggplot(data, aes(x=zsur, y=rexvote)) + geom_point() + geom_smooth(method = "glm", family = "binomial", se=FALSE) # Relationship w/ standardized unemployment rate

ggplot(data, aes(x=zasylumseekers, y=rexvote, color=country)) + geom_point() + geom_smooth(method= "glm", family = "binomial", se=FALSE) # Relationship w/ immigration

ggplot(data, aes(x=zreplacementrate, y=rexvote, color=country)) + geom_point() + geom_smooth(method=lm, se=FALSE) #Relationship w/ welfare (=unemp benefit)
```

# Run the regression (multilevel logictic regression based on Quasi-penalized likelihood): All contextual variables are mean-centered (as connoted by "z-")

```{r}
model1 <- glmmPQL(rexvote ~ male + age1 + age2 + age4 + mye1 + mye2 + farmerown + worker + retired + unemployed + zlrs + euschlecht + zsatisdmo + disp + lfed1 + zasylumseekers + zsur + zasylumseekers:zsur + zreplacementrate + zreplacementrate:zsur + zreplacementrate:zasylumseekers + rmax + salienzmean.c + rvar.c + rvar.c:salienzmean.c + country - 1, random=~1|kontext, family=binomial(link="logit"), data=data, verbose=TRUE)
summary(model1)

```


# Model 2 based on glm logit

```{r}
model2 <- glm(rexvote ~ male + age1 + age2 + age4 + mye1 + mye2 + farmerown + worker + retired + unemployed + zlrs + euschlecht + zsatisdmo + disp + lfed1 + zasylumseekers + zsur + zasylumseekers:zsur + zreplacementrate + zreplacementrate:zsur + zreplacementrate:zasylumseekers + rmax + salienzmean.c + rvar.c + rvar.c:salienzmean.c + country - 1, family=binomial(link="logit"), data=data, verbose=TRUE)
summary(model2)



# Visualize regression outputs??????? 

```{r}
library(car)
# Diagnostic 1: Residual Plots
# residualPlots(out.pql)

```

#Table 1

```{r}
# Create vectors of coefficients, standard deviations, and variable names

Coefficient <- as.vector(model1$coef$fixed) 
n <- c(174452, 267)

Standard_Deviation <- as.vector(sqrt(diag(model1$varFix))) 

var_names <- c("Male","18–29 years","30–45 years",">65 years","Education: middle/high","Education: university","Petty Bourgeoisie","Worker","Pensioner","Unemployed","Left-Right","Dissatisfied: EU","Dissatisfied: Democracy","Disproportionality","Decentralization","Asylumseekers", "Unemployment", "Asylumseekers × Unemployment", "Toughness", "Salience", "Variance", "AT", "BE", "DE-E", "DE-W", "DK", "ES", "FI", "FR", "GR", "IT", "NL", "NO", "PT", "SE", "Asylumseekers x Unemployment", "Unemployment benefits x Unemployment", "Unemployment benefits x Asylumseekers", "Variance x Salience")

# Create matrix of coefficients and standard deviations.

table_matrix <- cbind(Coefficient, Standard_Deviation)

##Label matrix.

rownames(table_matrix) <- c("Male","18_29 years","30_45 years",">65 years","Education: middle/high","Education: university","Petty Bourgeoisie","Worker","Pensioner","Unemployed","Left-Right","Dissatisfied: EU","Dissatisfied: Democracy","Disproportionality","Decentralization","Asylumseekers", "Unemployment", "Asylumseekers x Unemployment", "Toughness", "Salience", "Variance", "AT", "BE", "DE-E", "DE-W", "DK", "ES", "FI", "FR", "GR", "IT", "NL", "NO", "PT", "SE", "Asylumseekers x Unemployment", "Unemployment benefits x Unemployment", "Unemployment benefits x Asylumseekers", "Variance x Salience")

# Create table using xtable

x <- xtable(table_matrix, digits = 3, caption = "Logistic multilevel model. PQL2 estimates, model-based standard errors in parentheses. MI results based on 11 separate imputations.")
print.xtable(x, type = "html", file="tablepractice.html")

# Create Table 1 using stargaze

stargazer(table_matrix, title = "TABLE 1 Support for the Extreme Right: Sociodemographics, Attitudes, Country Effects, and Contextual Variables", align = TRUE, table.layout = "t", notes = "Logistic multilevel model. PQL2 estimates and model-based standard errors.", style = "ajps", out = "Table 1.html", no.space = TRUE)

```

# Figure 1 (Conditonal Effects of Unemployment and Immigration)

```{r}
library(msm)
asy <- seq(from = -.98, to=4.46, by=.01) # vector with possible values for asylumseekers
slopes <- model1$coef$fixed[17] + model1$coef$fixed[36] * asy # Estimated slopes based on estimated coefficients of unemployment (17) and unemployment x immigration (36)
estmean <- model1$coef$fixed # Estimated means for each variable 
var <- vcov(model1)
se <- rep(NA, length(asy))

for (i in 1:length(asy)) {
  j <- asy[i]
  se[i] <- deltamethod (~ (x17) + (x36)*j, estmean, var)
}

upper <- slopes + 1.96*se
lower <- slopes - 1.96*se
asy.data <- cbind(asy, slopes, upper, lower)
plot(asy, slopes, type = "l", lty = 1, ylim=c(-.2, .2), xlim=c(-2, 4), ylab= "Effect: Unemployment", xlab = "Asylumseekers", main = "The Conditional Effects of Unemployment and Immigration")
points(asy, upper, type = "l", lty = 2)
points(asy, lower, type = "l", lty = 2)
points(asy, rep(0, length(asy)), type = "l", col = "black")
```


