---
title: "Gozde and Liora Replication Code"
author: "Gozde Guran and Liora Goldensher"
date: "3/6/2015"
output: html_document
---

# Replication Code for "Contextual Factors and the Extreme Right Vote in Europe, 1980-2002" by Kai Arzheimer American Journal of Political Science (2009)

# Run necessary packages and load data (Source: Arzheimer dataverse)

```{r}
library(Zelig)
library(lme4)
library(MASS)
library(nlme)
library(plm)
library(xtable)
library(foreign)
library(dplyr)
library(broom)
library(ggplot2)
library(xtable)
library(stargazer)

data <- read.dta("nonimp.dta")

# Cleaning up data
data <- rename(data, ext_vote = rexvote)
data <- rename(data, age_1 = age1) # Age (16-25)
data <- rename(data, age_2 = age2) # Age 
data <- rename(data, age_4 = age4) # Age (65- )
data <- rename(data, edu_1 = mye1) 
data <- rename(data, edu_2 = mye2)
data <- rename(data, age_2 = age2)
data <- rename(data, farmer_own = farmerown)
data <- rename(data, left_right_scale = zlrs)
data <- rename(data, eu_neg = euschlecht) # Negative evaluation of EU membership of one's own country
data <- rename(data, z_dem_satis = zsatisdmo) 
data <- rename(data, dispro_elect = disp) 
data <- rename(data, federalism = lfed1)
data <- rename(data, z_asylumseeker = zasylumseekers)
data <- rename(data, z_unemp = zsur) 
data <- rename(data, z_replacement = zreplacementrate) 
data <- rename(data, max_er = rmax) 

```


# Create centered variables for Saliance and Variance based on grand mean centering according to author

```{r}
data <- data  %>% 
  mutate(salience_mean_c = (salienzmean - 3.84568)) %>% 
  mutate(var_c = rvar - 21.75423)
```

# Make male variable numeric

```{r}
data <- data %>%
  mutate(male = as.numeric(male))
```

# Create a dummy variable for country (transform from character to factor variable)

```{r}
data <- data %>%
  mutate(country = factor(sortcountry, labels = c("AT", "BE","DE-E","DE-W","DK","ES","FI","FR","GR","IT","LU","NL","NO","PT","SE")))
```

# Plot Data for exploration

```{r}
ggplot(data, aes(x = z_unemp, y = ext_vote)) + geom_point() + geom_smooth(method = "glm", family = "binomial", se = FALSE) # Relationship w/ standardized unemployment rate

ggplot(data, aes(x = z_asylumseeker, y = ext_vote, color = country)) + geom_point() + geom_smooth(method = "glm", family = "binomial", se = FALSE) # Relationship w/ immigration

ggplot(data, aes(x = z_replacement, y = ext_vote, color = country)) + geom_point() + geom_smooth(method = lm, se = FALSE) #Relationship w/ welfare (=unemp benefit)
```

# Run the regression (multilevel logictic regression based on Quasi-penalized likelihood): All contextual variables are standardized mean-centered (as connoted by "z-")

```{r}
model <- glmmPQL(ext_vote ~ male + age_1 + age_2 + age_4 + edu_1 + edu_2 + farmer_own + worker + retired + unemployed + left_right_scale + eu_neg + z_dem_satis + dispro_elect + federalism + z_asylumseeker + z_unemp + z_asylumseeker:z_unemp + z_replacement + z_replacement:z_unemp + z_replacement:z_asylumseeker + max_er + salience_mean_c + var_c + var_c:salience_mean_c + country - 1, random = ~1|kontext, family = binomial(link = "logit"), data = data, verbose = TRUE)
summary(model)

model1 <- glmmPQL(rexvote ~ male + age1 + age2 + age4 + mye1 + mye2 + farmerown + worker + retired + unemployed + zlrs + euschlecht + zsatisdmo + disp + lfed1 + zasylumseekers + zsur + zasylumseekers:zsur + zreplacementrate + zreplacementrate:zsur + zreplacementrate:zasylumseekers + rmax + salienzmean.c + rvar.c + rvar.c:salienzmean.c + country - 1, random=~1|kontext, family=binomial(link="logit"), data=data, verbose=TRUE)
summary(model1)

```


# Model 2 based on glm logit - comparison 

```{r}
model2 <- glm(rexvote ~ male + age1 + age2 + age4 + mye1 + mye2 + farmerown + worker + retired + unemployed + zlrs + euschlecht + zsatisdmo + disp + lfed1 + zasylumseekers + zsur + zasylumseekers:zsur + zreplacementrate + zreplacementrate:zsur + zreplacementrate:zasylumseekers + rmax + salienzmean.c + rvar.c + rvar.c:salienzmean.c + country - 1, family=binomial(link="logit"), data=data, verbose=TRUE)
summary(model2)

```

#Table 1

```{r}
# Create vectors of coefficients, standard deviations, and variable names

coefficient <- as.vector(model$coef$fixed) 
n <- c(174452, 267)

stand_dev <- as.vector(sqrt(diag(model$varFix))) 

var_names <- c("Male","18–29 years","30–45 years",">65 years","Education: middle/high","Education: university","Petty Bourgeoisie","Worker","Pensioner","Unemployed","Left-Right","Dissatisfied: EU","Dissatisfied: Democracy","Disproportionality","Decentralization","Asylumseekers", "Unemployment", "Asylumseekers × Unemployment", "Toughness", "Salience", "Variance", "AT", "BE", "DE-E", "DE-W", "DK", "ES", "FI", "FR", "GR", "IT", "NL", "NO", "PT", "SE", "Asylumseekers x Unemployment", "Unemployment benefits x Unemployment", "Unemployment benefits x Asylumseekers", "Variance x Salience")

# Create matrix of coefficients and standard deviations.

table_matrix <- cbind(coefficient, stand_dev)

##Label matrix.

rownames(table_matrix) <- c("Male","18_29 years","30_45 years",">65 years","Education: middle/high","Education: university","Petty Bourgeoisie","Worker","Pensioner","Unemployed","Left-Right","Dissatisfied: EU","Dissatisfied: Democracy","Disproportionality","Decentralization","Asylumseekers", "Unemployment", "Asylumseekers x Unemployment", "Toughness", "Salience", "Variance", "AT", "BE", "DE-E", "DE-W", "DK", "ES", "FI", "FR", "GR", "IT", "NL", "NO", "PT", "SE", "Asylumseekers x Unemployment", "Unemployment benefits x Unemployment", "Unemployment benefits x Asylumseekers", "Variance x Salience")

# Create table using xtable

x <- xtable(table_matrix, digits = 3, caption = "Logistic multilevel model. PQL2 estimates, model-based standard errors in parentheses. MI results based on 11 separate imputations.")
print.xtable(x, type = "html", file="tablepractice.html")

# Create Table 1 using stargaze

stargazer(table_matrix, title = "TABLE 1 Support for the Extreme Right: Sociodemographics, Attitudes, Country Effects, and Contextual Variables", align = TRUE, table.layout = "t", notes = "Logistic multilevel model. PQL2 estimates and model-based standard errors.", style = "ajps", out = "Table 1.html", no.space = TRUE)

```

# Figure 1 (Conditonal Effects of Unemployment and Immigration)

```{r}
library(msm)
asy <- seq(from = -.98, to = 4.46, by = .01) # vector with possible values for asylumseekers
variable <- asy
slopes <- model$coef$fixed[17] + model$coef$fixed[36] * asy # Estimated slopes based on estimated coefficients of unemployment (17) and unemployment x immigration (36)
estmean <- model$coef$fixed # Estimated means for each variable 
var <- vcov(model)
se <- rep(NA, length(asy))

for (i in 1:length(variable)) {
  j <- variable[i]
  se[i] <- deltamethod (~ (x17) + (x36) * j, estmean, var)
}
# Create confidence intervals and combine all values in matrix.
upper <- slopes + 1.96 * se
lower <- slopes - 1.96 * se
variable.data <- cbind(variable, slopes, upper, lower)

# Creating the first graph in base R 
par(mfrow = c(2, 1))
plot(variable, slopes, type = "l", lty = 1, ylim = c(-.2, .2), xlim = c(-2, 4), ylab = "Effect: Unemployment", xlab = "Asylumseekers", main = "The Conditional Effects of Unemployment and Immigration")
points(variable, upper, type = "l", lty = 2)
points(variable, lower, type = "l", lty = 2)
points(variable, rep(0, length(variable)), type = "l", col = "black")

# Creating the same graph with ggplot - much better looking.

variable.data <- data.frame(variable.data) # Turn matrix into data frame so that ggplot can read it.
xtitle <- "Asylumseekers"
ytitle <- "Effect: Unemployment"
main <- "Figure 1: The Conditional Effects of Unemployment and Immigration"
graph1 <- ggplot(variable.data, aes(x = variable, y = slopes)) + 
  geom_line(aes(y = slopes), color = "blue") + 
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2) + 
  geom_hline(yintercept = 0, size = 0.4, color = "black") +
  labs(x = xtitle, y = ytitle, title = main)

#Figure 1, graph 2

unemployment <- seq(from = -5.908098, to = 12.291902, by = .01) # vector with possible values for unemployment
variable <- unemployment
slopes <- model$coef$fixed[16] + model$coef$fixed[36] * variable # Estimated slopes based on estimated coefficients of unemployment (16) and unemployment x immigration (36)
estmean <- model$coef$fixed # Estimated means for each variable 
var <- vcov(model)
se <- rep(NA, length(variable))

for (i in 1:length(variable)) {
  j <- variable[i]
  se[i] <- deltamethod (~ (x16) + (x36) * j, estmean, var)
}
# Create confidence intervals and combine all values in matrix.
upper <- slopes + 1.96 * se
lower <- slopes - 1.96 * se
variable.data <- cbind(variable, slopes, upper, lower)

# Creating the first graph in base R 

plot(variable, slopes, type = "l", lty = 1, ylim=c(-.4, .6), xlim=c(-5, 15), ylab= "Effect: Asylum seekers", xlab = "Unemployment", main = "The Conditional Effects of Unemployment and Immigration")
points(variable, upper, type = "l", lty = 2)
points(variable, lower, type = "l", lty = 2)
points(variable, rep(0, length(variable)), type = "l", col = "black")

# Creating the same graph with ggplot:

variable.data <- data.frame(variable.data) # Turn matrix into data frame so that ggplot can read it.
xtitle <- "Unemployment"
ytitle <- "Effect: Asylum seekers"
main <- "The Conditional Effects of Unemployment and Immigration"
graph2 <- ggplot(variable.data, aes(x = variable, y = slopes)) + 
  geom_line(aes(y = slopes), color = "blue") + 
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2) + 
  geom_hline(yintercept = 0, size = 0.4, color = "black") +
  labs(x = xtitle, y = ytitle)

# Figure 1 with ggplot
library(grid)
library(gridExtra)
grid.arrange(graph1, graph2, ncol = 1)

```

```{r}

# Figure 2, graph 1 (Conditonal Effects of Salience and Variance)

salience <- seq(from = -3.108026, to = 21.872906, by=.1) # vector with possible values for salience
variable <- salience
slopes <- model$coef$fixed[21] + model$coef$fixed[39] * variable # Estimated slopes based on estimated coefficients of salience (20) and salience x variance (39)
estmean <- model$coef$fixed # Estimated means for each variable 
var <- vcov(model)
se <- rep(NA, length(variable))

for (i in 1:length(variable)) {
  j <- variable[i]
  se[i] <- deltamethod (~ (x21) + (x39)*j, estmean, var)
}
# Create confidence intervals and combine all values in matrix.
upper <- slopes + 1.96*se
lower <- slopes - 1.96*se
variable.data <- cbind(variable, slopes, upper, lower)


# Creating the first graph in base R 

plot(variable, slopes, type = "l", lty = 1, ylim=c(-.02, .03), xlim=c(-5, 20), ylab= "Effect: Variance", xlab = "Salience", main = "The Conditional Effects of Salience and Variance")
points(variable, upper, type = "l", lty = 2)
points(variable, lower, type = "l", lty = 2)
points(variable, rep(0, length(variable)), type = "l", col = "black")

# Creating the same graph with ggplot - much better looking.
library(ggplot2)
variable.data <- data.frame(variable.data) # Turn matrix into data frame so that ggplot can read it.
xtitle <- "Salience"
ytitle <- "Effect: Variance"
main <- "The Conditional Effects of Salience and Variance"
graph3 <- ggplot(variable.data, aes(x = variable, y = slopes)) + 
  geom_line(aes(y = slopes), color = "blue") + 
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2) + 
  geom_hline(yintercept = 0, size = 0.4, color = "black") +
  labs(x = xtitle, y = ytitle, title = main)
```

